<script>
/**
 * ARCHIVO: Scripts.html 
 * ÚLTIMA MODIFICACIÓN: 2026/01/18 17:15:00
 * COMENTARIOS:
 * 1. ELIMINADA: función initResizable (duplicidad con ModuloUI.html).
 * 2. MANTENIDAS: Lógica de carga de secciones, ordenación y logs.
 */

window.selectedRowData = null;
window.currentData = { archivo_id: "", modulo: "" };

window.onload = function() {
  google.script.run
    .withSuccessHandler(res => {
      if(res) {
        document.getElementById('user-name').innerText = res.nombre || "";
        document.getElementById('user-role').innerText = res.rol || "";
        registrarLog("identidad_cargada", "index", res);
        if (typeof pintar_menu_principal === 'function') pintar_menu_principal(res.menu);
      }
    })
    .get_user_data();
  const spinner = document.getElementById('loading-spinner');
  if (spinner) spinner.style.display = 'none';
};

function cargarSeccion(nombre) {
  const spinner = document.getElementById('loading-spinner');
  if (spinner) spinner.style.display = 'block';
  google.script.run
    .withSuccessHandler(res => {
      if (spinner) spinner.style.display = 'none';
      if (!res) return;
      window.currentData.archivo_id = res.archivo_id || "";
      window.currentData.modulo = res.modulo || "";
      registrarLog("datos_recibidos", nombre, res);
      if (typeof pintar_contenido === 'function') pintar_contenido(res);
    })
    .get_data_tabla_generica(nombre);
}

function registrarLog(evento, pestana, valores) {
  const logCont = document.getElementById('debug-log');
  if (!logCont) return;
  const ahora = new Date();
  const f = ahora.getFullYear() + '/' + String(ahora.getMonth() + 1).padStart(2, '0') + '/' + String(ahora.getDate()).padStart(2, '0') + ' ' + String(ahora.getHours()).padStart(2, '0') + ':' + String(ahora.getMinutes()).padStart(2, '0') + ':' + String(ahora.getSeconds()).padStart(2, '0');
  
  const logItem = document.createElement('div');
  logItem.style.borderBottom = "1px solid #444";
  logItem.style.padding = "2px 0";
  logItem.innerHTML = `[${f}] [tab: ${pestana}] [acc: ${evento}] data: ${JSON.stringify(valores)}`;
  logCont.prepend(logItem);
}

function limpiarLog() {
  const logCont = document.getElementById('debug-log');
  if (logCont) logCont.innerHTML = '';
}

function ordenarTabla(n) {
  const tabla = document.getElementById("tabla-datos-principal");
  if (!tabla) return;
  let filas, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
  switching = true; dir = "asc"; 
  while (switching) {
    switching = false; filas = tabla.rows;
    for (i = 1; i < (filas.length - 1); i++) {
      shouldSwitch = false;
      x = filas[i].getElementsByTagName("TD")[n];
      y = filas[i + 1].getElementsByTagName("TD")[n];
      if (dir == "asc" && x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) { shouldSwitch = true; break; }
      if (dir == "desc" && x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) { shouldSwitch = true; break; }
    }
    if (shouldSwitch) { filas[i].parentNode.insertBefore(filas[i + 1], filas[i]); switching = true; switchcount ++; }
    else if (switchcount == 0 && dir == "asc") { dir = "desc"; switching = true; }
  }
}

function ejecutarAccionModulo(accionRaw) {
  try {
    const partes = accionRaw.split('(');
    const nombreFunc = partes[0].trim();
    const param = partes[1] ? partes[1].split("'")[1] : null;
    if (typeof window[nombreFunc] === 'function') window[nombreFunc](param);
  } catch (e) { registrarLog("error_ejecucion", "js", e.message); }
}

function filtrarListadoUniversal() {
  const input = document.getElementById('buscador-global');
  const tabla = document.getElementById('tabla-datos-principal');
  if (!input || !tabla) return;
  const filter = input.value.toLowerCase();
  const filas = tabla.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
  for (let i = 0; i < filas.length; i++) {
    filas[i].style.display = filas[i].innerText.toLowerCase().includes(filter) ? "" : "none";
  }
}
</script>