<script>
/**
 * ARCHIVO: Scripts.html 
 * Versión: v30.21 - Redirección a URL Invitado
 */

window.selectedRowData = null;
window.currentData = { archivo_id: "", modulo: "" };

window.onload = function() {
  google.script.run
    .withSuccessHandler(res => {
      if(res) {
        document.getElementById('user-name').innerText = res.nombre || "";
        document.getElementById('user-role').innerText = res.rol || "";
        registrarLog("identidad_cargada", "index", res);
        if (typeof pintar_menu_principal === 'function') pintar_menu_principal(res.menu);
      }
    })
    .get_user_data();
};

function solicitarCierreSesion() {
  const btn = document.getElementById('btn-estado-sesion');
  if (btn) btn.style.opacity = "0.5";

  google.script.run
    .withSuccessHandler(function(urlDestino) {
      window.top.location.href = urlDestino;
    })
    .withFailureHandler(function(err) {
      window.top.location.href = "<?= CONFIG.Homeurl ?>";
    })
    .ejecutar_cierre_sesion();
}

function cargarSeccion(nombre) {
  google.script.run
    .withSuccessHandler(res => {
      if (!res) return;
      window.currentData.archivo_id = res.archivo_id || "";
      window.currentData.modulo = res.modulo || "";
      registrarLog("datos_recibidos", nombre, res);
      if (typeof pintar_contenido === 'function') pintar_contenido(res);
    })
    .get_data_tabla_generica(nombre);
}

function registrarLog(evento, pestana, valores) {
  if (parseInt("<?= CONFIG.Log ?>") === 0) return;
  const logCont = document.getElementById('debug-log');
  if (!logCont) return;
  const ahora = new Date();
  const f = ahora.getFullYear() + '/' + String(ahora.getMonth() + 1).padStart(2, '0') + '/' + String(ahora.getDate()).padStart(2, '0') + ' ' + String(ahora.getHours()).padStart(2, '0') + ':' + String(ahora.getMinutes()).padStart(2, '0') + ':' + String(ahora.getSeconds()).padStart(2, '0');
  const logItem = document.createElement('div');
  logItem.style.borderBottom = "1px solid #444";
  logItem.style.padding = "2px 0";
  logItem.innerHTML = `[${f}] [tab: ${pestana}] [acc: ${evento}] data: ${JSON.stringify(valores)}`;
  logCont.prepend(logItem);
}

function limpiarLog() {
  const logCont = document.getElementById('debug-log');
  if (logCont) logCont.innerHTML = '';
}
</script>