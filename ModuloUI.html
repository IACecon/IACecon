<script>
/**
 * archivo: ModuloUI.html
 * Versión: v23.0 - Lógica Manual (Sin Frameworks)
 */

window.menuCompleto = []; 

function pintar_menu_principal(menu) {
  const container = document.getElementById('main-menu-container');
  if (!container || !menu) return;
  window.menuCompleto = menu; 
  
  let html = '';
  menu.forEach((item, index) => {
    html += `<div class="sidebar-link" id="side-${index}" onclick="seleccionarSidebar(this, '${item.sidebar}')">${item.sidebar}</div>`;
  });
  container.innerHTML = html;
  
  // Seleccionar el primero por defecto
  const primerEnlace = document.getElementById('side-0');
  if (primerEnlace) seleccionarSidebar(primerEnlace, menu[0].sidebar);
}

function seleccionarSidebar(elemento, titulo) {
  // Resetear estados activos
  document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active-menu'));
  elemento.classList.add('active-menu');
  
  const info = window.menuCompleto.find(m => m.sidebar === titulo);
  if (info) {
    if (info.pestanas && info.pestanas.length > 0) {
      pintar_tabs(info.pestanas);
    } else {
      document.getElementById('sub-menu-tabs').innerHTML = '';
      cargarSeccion(titulo);
    }
  }
}

function pintar_tabs(lista) {
  const container = document.getElementById('sub-menu-tabs');
  if (!container) return;
  
  let html = '';
  lista.forEach((p, index) => {
    const clase = index === 0 ? 'active-tab' : '';
    html += `<li class="${clase}" onclick="seleccionarTab(this, '${p}')">${p}</li>`;
  });
  container.innerHTML = html;
  cargarSeccion(lista[0]);
}

function seleccionarTab(elemento, nombre) {
  document.querySelectorAll('#sub-menu-tabs li').forEach(li => li.classList.remove('active-tab'));
  elemento.classList.add('active-tab');
  cargarSeccion(nombre);
}

function pintar_contenido(res) {
  const contenedor = document.getElementById('dynamic-content');
  if (!contenedor || !res) return;

  // CASO: DESARROLLO / ERROR (Mensaje visual en pantalla)
  if (res.tipo === "desarrollo" || res.tipo === "error_vinculacion") {
    const d = res.debug || {};
    contenedor.innerHTML = `
      <div style="border: 2px solid var(--color-principal); padding: 20px; border-radius: 8px;">
        <h3 style="color: var(--color-principal); margin-top:0;"><i class="material-icons" style="vertical-align: middle;">construction</i> ${res.mensaje}</h3>
        <p><b>Fila Auditada:</b> ${d.fila || '?'}</p>
        <hr>
        <p><b>Col E (ID):</b> ${d.e || 'Vacío'}</p>
        <p><b>Col F (GS):</b> ${d.f || 'Vacío'}</p>
        <p><b>Col G (HTML):</b> ${d.g || 'Vacío'}</p>
        <p style="color: red; margin-top: 20px;"><b>Nota:</b> ${res.tipo === "error_vinculacion" ? "El código GS no responde." : "Parámetros incompletos."}</p>
      </div>`;
    return;
  }

  // CASO: ÉXITO (Tabla)
  if (res.headers) {
    let html = '<table><thead><tr>';
    res.headers.forEach(h => html += `<th>${h}</th>`);
    html += '</tr></thead><tbody>';
    res.rows.forEach(row => {
      html += '<tr>';
      row.forEach(cell => html += `<td>${cell || ''}</td>`);
      html += '</tr>';
    });
    html += '</tbody></table>';
    contenedor.innerHTML = html;
  }
}

function cargarSeccion(nombre) {
  const content = document.getElementById('dynamic-content');
  if (content) content.innerHTML = 'Cargando...';
  
  google.script.run
    .withSuccessHandler(pintar_contenido)
    .get_data_tabla_generica(nombre);
}
</script>