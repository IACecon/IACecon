<style>
  /* Encapsulamos todo para no romper el resto de la App */
  #gestion-usuarios-modulo .btn-cecon { 
    border-radius: 8px !important; 
    text-transform: none !important; 
    padding: 0 18px !important; 
    height: 34px; 
    color: white !important; 
    border: none !important;
    margin-left: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    cursor: pointer;
  }

  /* Color de Selección de la fila (Desde Admin) */
  #gestion-usuarios-modulo #tabla-contenedor table tbody tr.selected-row,
  #gestion-usuarios-modulo #tabla-contenedor table tbody tr.selected-row td { 
    background-color: var(--u-color-sel, #1bb09e) !important; 
    color: white !important; 
  }

  /* Color Corporativo para Cabeceras */
  #gestion-usuarios-modulo #tabla-contenedor thead { 
    background-color: var(--u-color-corp, #138275) !important; 
    color: white !important; 
  }

  /* Estilos Formulario */
  .form-overlay {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.4); z-index: 10000; justify-content: center; align-items: center;
  }
  .form-card { background: white; padding: 25px; border-radius: 8px; width: 90%; max-width: 650px; }
  .form-card h5 { color: var(--u-color-corp, #138275); margin-bottom: 25px; font-weight: 300; }
  
  /* Arreglo para etiquetas solapadas (Imagen 1) */
  .input-field { margin-bottom: 20px !important; }
  .input-field label.active { transform: translateY(-14px) scale(0.8) !important; color: var(--u-color-corp) !important; }

  select.browser-default {
    border: 1px solid #ccc; border-radius: 4px; height: 2.5rem; margin-top: 5px;
  }
</style>

<div id="gestion-usuarios-modulo">
  <div id="gestion-usuarios-overlay" class="form-overlay">
    <div class="form-card">
      <h5 id="form-titulo">gestión de usuario</h5>
      <div id="campos-edicion">
        <div class="row" style="margin-bottom:0">
          <div class="input-field col s12 m6"><input id="u_nombre" type="text"><label for="u_nombre">Nombre</label></div>
          <div class="input-field col s12 m6"><input id="u_apellidos" type="text"><label for="u_apellidos">Apellidos</label></div>
        </div>
        <div class="row" style="margin-bottom:0">
          <div class="input-field col s12 m6"><input id="u_mail" type="email"><label for="u_mail">Email</label></div>
          <div class="input-field col s12 m6"><input id="u_tel" type="text"><label for="u_tel">Teléfono</label></div>
        </div>
        <div class="row" style="margin-bottom:0">
          <div class="col s12 m6">
            <label style="font-size:0.8rem">Rol</label>
            <select id="u_rol" class="browser-default">
              <option value="Vigilante">Vigilante</option>
              <option value="Jefe de Equipo">Jefe de Equipo</option>
              <option value="Director/Jefe de Seguridad">Director/Jefe de Seguridad</option>
              <option value="Gerencia">Gerencia</option>
            </select>
          </div>
          <div class="col s12 m6">
            <label style="font-size:0.8rem">Restricción</label>
            <select id="u_restriccion" class="browser-default" onchange="gestionarCambioRestriccion()">
              <option value="No">No</option>
              <option value="Diurno">Diurno</option>
              <option value="Otra">Otra</option>
            </select>
          </div>
        </div>
        <div class="row" style="margin-top:15px">
          <div class="col s12 m6"><label>H. Inicio</label><select id="u_inicio" class="browser-default"></select></div>
          <div class="col s12 m6"><label>H. Fin</label><select id="u_fin" class="browser-default"></select></div>
        </div>
      </div>
      <div id="campos-baja" style="display:none;"><p id="baja-msg" style="text-align:center; padding:20px; font-size:1.2rem"></p></div>
      <div style="text-align:right; margin-top:20px">
        <button class="btn-cecon" style="background-color:#9e9e9e" onclick="cerrarFormulario()">Cancelar</button>
        <button id="btn-accion-form" class="btn-cecon">Acción</button>
      </div>
    </div>
  </div>
</div>

<script>
  function aplicarColoresDinamicos() {
    const mod = document.getElementById('gestion-usuarios-modulo');
    if (window.currentData && window.currentData.config) {
      const c = window.currentData.config;
      mod.style.setProperty('--u-color-corp', c.color_corporativo);
      mod.style.setProperty('--u-color-sel', c.color_seleccion);
      // Aplicar colores a los botones de la lista (Alta, Mod, Baja)
      document.querySelectorAll('.botones-container .btn-alta').forEach(b => b.style.backgroundColor = c.color_corporativo);
    }
  }

  function poblarHoras() {
    const selects = ['u_inicio', 'u_fin'];
    selects.forEach(id => {
      const el = document.getElementById(id); el.innerHTML = '<option value=""></option>';
      for (let h=0; h<24; h++) {
        for (let m=0; m<60; m+=30) {
          let hStr = h.toString().padStart(2,'0') + ":" + m.toString().padStart(2,'0');
          el.appendChild(new Option(hStr, hStr));
        }
      }
    });
  }

  function gestionarCambioRestriccion() {
    const r = document.getElementById('u_restriccion').value;
    const i = document.getElementById('u_inicio'), f = document.getElementById('u_fin');
    i.disabled = f.disabled = (r !== 'Otra');
    if (r === 'No') { i.value = f.value = ""; }
    else if (r === 'Diurno') { i.value = "06:00"; f.value = "22:00"; }
  }

  function ejecutarAccionModulo(accion) {
    aplicarColoresDinamicos();
    poblarHoras();
    const overlay = document.getElementById('gestion-usuarios-overlay');
    if ((accion === 'modificar' || accion === 'baja') && !window.selectedRowData) {
      M.toast({html: 'Seleccione un registro', classes: 'orange'}); return;
    }
    overlay.style.display = 'flex';
    document.getElementById('campos-edicion').style.display = accion==='baja'?'none':'block';
    document.getElementById('campos-baja').style.display = accion==='baja'?'block':'none';
    
    const btn = document.getElementById('btn-accion-form');
    if (accion === 'alta') {
      document.getElementById('form-titulo').innerText = 'Alta de usuario';
      btn.innerText = 'Registrar'; btn.style.backgroundColor = window.currentData.config.color_corporativo;
      btn.onclick = () => enviarServidor("alta");
      limpiarCampos(); gestionarCambioRestriccion();
    } else if (accion === 'modificar') {
      document.getElementById('form-titulo').innerText = 'Modificar usuario';
      btn.innerText = 'Guardar'; btn.style.backgroundColor = "#d35400";
      btn.onclick = () => enviarServidor("modificar");
      const d = window.selectedRowData;
      document.getElementById('u_nombre').value = d[0]; document.getElementById('u_nombre').disabled = true;
      document.getElementById('u_apellidos').value = d[1]; document.getElementById('u_apellidos').disabled = true;
      document.getElementById('u_mail').value = d[2]; document.getElementById('u_tel').value = d[3];
      document.getElementById('u_rol').value = d[4] || 'Vigilante';
      document.getElementById('u_restriccion').value = d[7] || "No";
      gestionarCambioRestriccion();
      if(d[8]) document.getElementById('u_inicio').value = d[8];
      if(d[9]) document.getElementById('u_fin').value = d[9];
    } else if (accion === 'baja') {
      document.getElementById('form-titulo').innerText = 'Baja de usuario';
      document.getElementById('baja-msg').innerText = '¿Confirmar baja de ' + window.selectedRowData[0] + '?';
      btn.innerText = 'Confirmar'; btn.style.backgroundColor = "#b03a2e";
      btn.onclick = () => enviarServidor("baja");
    }
    // ARREGLO IMAGEN 1: Forzar etiquetas arriba
    setTimeout(() => { 
      M.updateTextFields(); 
      document.querySelectorAll('.input-field label').forEach(l => l.classList.add('active'));
    }, 100);
  }

  function cerrarFormulario() { document.getElementById('gestion-usuarios-overlay').style.display = 'none'; }
  function limpiarCampos() {
    ['u_nombre', 'u_apellidos', 'u_mail', 'u_tel'].forEach(id => { 
      const el = document.getElementById(id); el.value = ''; el.disabled = false; 
    });
  }

  function enviarServidor(modo) {
    const data = {
      nombre: document.getElementById('u_nombre').value,
      apellidos: document.getElementById('u_apellidos').value,
      mail: document.getElementById('u_mail').value,
      tel: document.getElementById('u_tel').value,
      rol: document.getElementById('u_rol').value,
      restriccion: document.getElementById('u_restriccion').value,
      h_inicio: document.getElementById('u_inicio').value,
      h_fin: document.getElementById('u_fin').value
    };
    google.script.run.withSuccessHandler(res => {
      if (res.status === "ok") { cerrarFormulario(); cargarSeccion("Gestión de Usuarios"); M.toast({html: 'Hecho'}); }
    }).router_modulo("GestionUsuarios", "ejecutar_accion", [window.currentData.archivo_id, modo, data]);
  }
</script>